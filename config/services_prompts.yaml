# DFM Prompt-bibliotek (services_prompts.yaml)

# --- Transformations-agenten (Ljud/Video) ---
transcriber:
  analysis_prompt: |
    {context_injection}

    Du får en rå transkription från en ljudfil. Utför följande tre steg:
    
    STEG 1: KVALITETSKONTROLL
    Bedöm om transkriberingen är ANVÄNDBAR.
    Returnera quality_status "FAILED" om NÅGOT av följande stämmer:
    - Mindre än 50 meningsfulla ord (exkludera talarmarkeringar)
    - Bara talarmarkeringar utan faktiskt innehåll ("Talare 1: Talare 2: Talare 3:")
    - Samma ord eller fras upprepas mer än 10 gånger i rad
    - Innehållet är oförståeligt, korrupt eller nonsens
    - Bara tystnad, ljud-markeringar eller bakgrundsljud
    Om FAILED: Ange failure_reason och hoppa över steg 2-3.
    
    STEG 2: KORRIGERAD TRANSKRIPTION (endast om quality_status är "OK")
    - Identifiera talarna från innehållet (de presenterar sig ofta i början).
    - VIKTIGT: Om "MÖTESKONTEXT" angavs ovan, använd deltagarlistan därifrån för att avgöra vilka talarna är.
    - Skriv ut HELA transkriptionen med riktiga namn där det är möjligt.
    - Format: "Namn: text" (Talarnamn, kolon, mellanslag).
    - Om ett namn är okänt, behåll "Talare N".
    - Standardisera formatet (ta bort hakparenteser, fixa radbrytningar).
    - Behåll allt innehåll - korta inte ner.
    
    STEG 3: METADATA
    Extrahera strukturerad information från innehållet.
    Använd MÖTESKONTEXT för att fylla i syfte och entiteter om det är otydligt i ljudet.
    
    RETURNERA EXAKT DENNA JSON-STRUKTUR:
    {
      "quality_status": "OK" eller "FAILED",
      "failure_reason": "Endast vid FAILED - kortfattad förklaring",
      "transcript": "Den korrigerade transkriptionen med riktiga namn och enhetligt format",
      "speakers": ["Lista med identifierade talare"],
      "summary": "Sammanfattning på svenska av vad som diskuteras",
      "keywords": ["Relevanta sökord"],
      "entities": ["Personer", "Organisationer", "Projekt som nämns"]
    }

# --- Doc Converter (Textfiler/Dokument) - OPTIMERAD ---
doc_converter:
  generate_metadata: |
    Sammanfatta följande text på svenska.
    Fokusera på det viktigaste innehållet, beslut och entiteter.
    Generera även 5-10 relevanta nyckelord (tags).

    Text:
    {text_chunk}

    JSON Output:
    {{
      "summary": "...",
      "keywords": ["tag1", "tag2"]
    }}

  doc_summary_prompt: |
    Sammanfatta detta dokument kortfattat och informativt på svenska.
    Fokusera på VAD det är, VEM det berör och VILKA beslut/händelser som nämns.

    TEXT:
    {text}

    RETURNERA JSON:
    {{
      "summary": "Din sammanfattning här...",
      "keywords": ["nyckelord1", "nyckelord2"]
    }}

  strict_entity_extraction: |
      Du är en expert på Knowledge Graph Extraction. Din uppgift är att strukturera ostrukturerad text till en graf bestående av Noder och Relationer, strikt baserat på det bifogade schemat.
      
      TEXT ATT ANALYSERA:
      "{text_chunk}"
      
      === DITT SCHEMA (Detta är din lag) ===
      Här är de enda nodtyper och relationer du får skapa. Använd definitionerna för att avgöra "Schema-Fit" (hur väl datan matchar kraven).
      
      TILLÅTNA NODTYPER:
      {node_types_context}
      
      TILLÅTNA RELATIONSTYPER:
      {edge_types_context}
      
      === KÄNDA ENTITETER (ANKARE) ===
      Här är entiteter som vi REDAN VET existerar i systemet.
      Om du hittar namn som matchar nedan, MÅSTE du återanvända deras UUID exakt som det står här:
      {known_entities_context}
      
      === INSTRUKTIONER ===
      1. EXTRAHERA NODER:
        - Identifiera entiteter som matchar schemat.
        - "confidence": Sätts baserat på "Schema-Fit" (0.0 - 1.0).
          * 0.8-1.0 (Hög): Entiteten uppfyller definitionen tydligt och har unika attribut (t.ex. Projekt med namn + deadline + ägare).
          * <0.3 (Låg/Brus): Entiteten är generisk eller trivial (t.ex. "Mötet", "Fikat", "Teamet" utan namn) eller saknar särskiljande drag.
        - "context_keywords": Lista 2-4 nyckelord som beskriver entitetens roll/kontext (för deduplicering).
        - "status": Sätt ALLTID till "PROVISIONAL" (om det inte är ett Ankare som du återanvänder).
      
      2. SKAPA RELATIONER:
        - Identifiera kopplingar mellan noderna.
        - "confidence": Sätts baserat på hur explicit kopplingen är i texten.
        - Använd endast relationstyper från schemat.
      
      3. ANKARE (Prioritet 1):
        - Kontrollera alltid listan "KÄNDA ENTITETER" först.
        - Om texten nämner "Jocke" och listan innehåller en "Jocke" med UUID "123-abc", använd "123-abc" i uuid-fältet.
      
      4. NEGATIVA REGLER:
        - Ignorera generella substantiv ("kaffe", "rum", "idé") som inte är namngivna entiteter.
        - Skapa ALDRIG noder av typen 'Document' eller 'Source'.
        - Hitta inte på egna relationstyper.
      
      RETURNERA JSON (Exakt format):
      {{
        "nodes": [
          {{ 
            "name": "Namn", 
            "uuid": "uuid-från-ankare-eller-null", 
            "type": "Nodtyp", 
            "context_keywords": ["ord1", "ord2"], 
            "status": "PROVISIONAL",
            "confidence": 0.85
          }}
        ],
        "edges": [
          {{ "source": "NamnEllerUUID", "target": "NamnEllerUUID", "type": "RELATIONSTYP", "confidence": 0.9 }}
        ]
      }}